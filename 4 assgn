"""
Assignment Solutions
- Chi-Square test (Association between Device Type and Customer Satisfaction)
- Hypothesis testing (Bombay hospitality Ltd. weekly operating cost)

This script computes all required values, prints intermediate calculations, and writes a short conclusion for each problem.

Instructions: run with Python 3. If scipy is installed the script will compute precise p-values and critical values; otherwise it falls back to known critical constants.
"""

import math
import numpy as np

# ---------- Problem 1: Chi-Square Test ----------
# Observed contingency table:
# Rows: [Very Satisfied, Satisfied, Neutral, Unsatisfied, Very Unsatisfied]
# Columns: [Smart Thermostat, Smart Light]
obs = np.array([
    [50, 70],   # Very Satisfied
    [80,100],   # Satisfied
    [60, 90],   # Neutral
    [30, 50],   # Unsatisfied
    [20, 50],   # Very Unsatisfied
], dtype=float)

row_totals = obs.sum(axis=1)
col_totals = obs.sum(axis=0)
grand_total = obs.sum()

# Expected counts under independence: E_ij = (row_i_total * col_j_total) / grand_total
expected = np.outer(row_totals, col_totals) / grand_total

# Chi-square statistic
chi2_stat = ((obs - expected) ** 2 / expected).sum()

# Degrees of freedom: (r-1)*(c-1)
r, c = obs.shape
df = (r - 1) * (c - 1)

# Critical value and p-value (try to use scipy if available)
try:
    from scipy.stats import chi2
    chi2_crit = chi2.ppf(0.95, df)        # alpha = 0.05
    p_value_chi2 = 1 - chi2.cdf(chi2_stat, df)
except Exception:
    # Fallback constant for chi-square critical value with df=4 at alpha=0.05
    chi2_crit = 9.487729036781154
    p_value_chi2 = None

# Decision: compare chi2_stat with critical value
reject_null_chi2 = chi2_stat > chi2_crit

# ---------- Problem 2: Hypothesis Testing (One-sided Z-test) ----------
# Given model: W = 1000 + 5X, where X ~ N(mu_X=600, sigma_X=25)
# Theoretical mean weekly cost under model (for X=600): mu_W = 1000 + 5*600
mu_W = 1000 + 5 * 600  # = 4000

# Population standard deviation for W: since W = 1000 + 5X, sigma_W = 5 * sigma_X
sigma_X = 25
sigma_W = 5 * sigma_X  # = 125

# Sample information
n = 25
xbar = 3050.0  # sample mean weekly cost (Rs. 3,050)

# Test statistic (Z): (xbar - mu_W) / (sigma_W / sqrt(n))
se = sigma_W / math.sqrt(n)
z_stat = (xbar - mu_W) / se

# One-sided (right-tail) test at alpha=0.05: critical z
try:
    from scipy.stats import norm
    z_crit = norm.ppf(0.95)
    p_value_z = 1 - norm.cdf(z_stat)  # right-tail p-value
except Exception:
    z_crit = 1.6448536269514722  # approximate
    p_value_z = None

# For the owners' claim "weekly operating costs are higher than the model suggests":
# H0: mu = mu_W (4000)
# H1: mu > mu_W (one-sided right tail)
# Decision: reject if z_stat > z_crit
reject_null_z = z_stat > z_crit

# ---------- Output results ----------
print("""Chi-Square Test: Association between Device Type and Customer Satisfaction
""")
print("Observed table (rows: satisfaction, cols: Thermostat, Light):")
print(obs.astype(int))
print()
print("Row totals:", row_totals.astype(int))
print("Column totals:", col_totals.astype(int))
print("Grand total:", int(grand_total))
print()
print("Expected counts under independence:")
print(np.round(expected, 3))
print()
print(f"Chi-square statistic = {chi2_stat:.6f}")
print(f"Degrees of freedom = {df}")
print(f"Critical value (alpha=0.05) = {chi2_crit:.6f}")
if p_value_chi2 is not None:
    print(f"p-value = {p_value_chi2:.6f}")
else:
    print("p-value: scipy not available in the environment; p-value not computed here.")
print("Decision: ", end="")
if reject_null_chi2:
    print("Reject the null hypothesis. There is evidence of an association between device type and satisfaction.")
else:
    print("Fail to reject the null hypothesis. No sufficient evidence of an association between device type and satisfaction.")

print('\n' + '-'*60 + '\n')

print("""Hypothesis Test: Weekly Operating Cost (Bombay hospitality Ltd.)
""")
print(f"Theoretical mean weekly cost (mu_W) = {mu_W:.2f}")
print(f"Sample mean (xbar) = {xbar:.2f}")
print(f"Population sd for W (sigma_W) = {sigma_W:.2f}")
print(f"Sample size n = {n}")
print(f"Standard error = {se:.6f}")
print()
print(f"Z test statistic = {z_stat:.6f}")
print(f"Critical z (alpha=0.05, one-sided right-tail) = {z_crit:.6f}")
if p_value_z is not None:
    print(f"p-value (right-tail) = {p_value_z:.6f}")
else:
    print("p-value: scipy not available in the environment; p-value not computed here.")
print("Decision: ", end="")
if reject_null_z:
    print("Reject the null hypothesis. There is evidence that weekly operating costs are higher than the model suggests.")
else:
    print("Fail to reject the null hypothesis. There is no evidence that weekly operating costs are higher than the model suggests.")

print('\nConclusions:')
print("1) Chi-Square test: based on the provided data, we do not reject independence between device type and satisfaction at alpha=0.05.")
print("2) Hypothesis test for weekly operating cost: the sample mean (3050) is far below the theoretical mean (4000), so there is no evidence supporting the claim that costs are higher than the model suggests.")

# Optionally, write detailed results to a small text report
with open('assignment_results_summary.txt', 'w') as f:
    f.write('Chi-Square Test Results\n')
    f.write(f'Chi-square statistic = {chi2_stat:.6f}\n')
    f.write(f'Degrees of freedom = {df}\n')
    f.write(f'Critical value (alpha=0.05) = {chi2_crit:.6f}\n')
    if p_value_chi2 is not None:
        f.write(f'p-value = {p_value_chi2:.6f}\n')
    f.write('\nHypothesis Test (Weekly Cost)\n')
    f.write(f'mu_W = {mu_W:.2f}\n')
    f.write(f'xbar = {xbar:.2f}\n')
    f.write(f'sigma_W = {sigma_W:.2f}\n')
    f.write(f'z_stat = {z_stat:.6f}\n')
    f.write(f'z_crit = {z_crit:.6f}\n')
    if p_value_z is not None:
        f.write(f'p-value (right-tail) = {p_value_z:.6f}\n')

print('\nA short summary report has been written to assignment_results_summary.txt')
